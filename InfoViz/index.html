<!DOCTYPE html>
<html>
<head>
	<title>InfoViz Assignment 2</title>
	<script type="text/javascript" src="./d3/d3.min.js"></script>
	<style type="text/css">
		.axis path,
		.axis line {
		    fill: none;
		    stroke: black;
		    shape-rendering: crispEdges;
		}
		.axis text {
		    font-family: sans-serif;
		    font-size: 11px;
		}
		.label {
		    font-size: 11px;
		}

		#year-header, #year-header2 {
			text-align: center
		}
		.button-bar {
			width: 600px;
		}
		.button {
			float: left;
			margin-left: 15px;
			cursor: pointer;
		}
		.play-button,
		.reset-button {
			float: left;
			margin-left: 15px;
			cursor: pointer;
		}
		.selected {
			font-weight: bold;
		}

		.circle {
  			stroke: #000;
		}
		div.tooltip {
			position: absolute;
			text-align: center;
			font-size: 12px;
		}
	</style>
</head>

<body>
	<h1>Global Competitiveness Index vs GDP</h1>
	<hr style="clear:both;">
	<div class="button-bar">
		<div class="play-button">Play All</div>
		<div class="reset-button">Reset</div>
	</div>
	<hr style="clear:both;">

	<div class="button-bar">
		<div class="button selected">2007</div>
		<div class="button">2008</div>
		<div class="button">2009</div>
		<div class="button">2010</div>
		<div class="button">2011</div>
		<div class="button">2012</div>
		<div class="button">2013</div>
		<div class="button">2014</div>
		<div class="button">2015</div>
		<div class="button">2016</div>
		<div class="button">2017</div>
	</div>
	<hr style="clear:both;">

	<div id="bubblePlot">
		<h3 id="year-header">Year: 2007</h3>

		<script type="text/javascript">
		// Define margins of the svg
		var margin = { top: 30, right: 30, bottom: 30, left: 300 };

		// Width and height variables
		var outer_width = 1300;
		var outer_height = 650;
		var svg_width = outer_width - margin.left - margin.right;
		var svg_height = outer_height - margin.top - margin.bottom;

		// The global data set object
		var dataset;

		// A global variable to toggle the play interval
		var playInterval;

		// The year to display
		var display_year = 2007;

		// The selected country for showing trails
		var country_selected = null;

		// Define the d3 color scale
		var colorScale = d3.scaleOrdinal(d3.schemeCategory10);

		// Set up the scale to be used on the x-axis
		var xScale = d3.scaleLog()
						.range([0, svg_width]);

		// Set up the scale to be used on the y-axis
		var yScale = d3.scaleLinear()
						.range([svg_height, 0]);

		// Create an x-axis connected to the x scale
		var xAxis = d3.axisBottom()
						.scale(xScale)
						.ticks(10, d3.format("d"));

		// Define y-axis
		var yAxis = d3.axisLeft()
				  		.scale(yScale)
						.ticks(6);

		// Define the div for the country tooltip
		var div = d3.select("body")
					.append("div")
					.attr("class", "tooltip")
					.style("opacity", 0);

		//Create SVG element as a group with the margins transform applied to it
		var svg = d3.select("body")
					.append("svg")
					.attr("width", svg_width + margin.left + margin.right)
					.attr("height", svg_height + margin.top + margin.bottom)
					.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		// Define a function that filters data by year
		function yearFilter(value) {
			return (value.Year == display_year);
		}

		// Define a function that filters colors by region
		function color(d) {
			return d.Region;
		}

		// Function to draw trail for the selected country
		function drawTrail () {
			var selected_country_data = dataset.filter(function(d) {
				if (country_selected != null) {
					return display_year >= d.Year && country_selected == d.Country;
				} else {
					return false;
				}
			});

			selected_country_data.forEach(function(d) {
				svg.append("circle")
					.attr("class", "circle")
					.attr("id", "trail")
					.attr("cx", xScale(d.GDP))
					.attr("cy", yScale(d.Global_Competitiveness_Index))
					.attr("r", Math.sqrt(d.Population / Math.PI) / 400)
					.attr("opacity", 1)
					.style("fill", colorScale(color(d)))
					.on("mouseover", function() {
						div.transition()
							.duration(500)
							.style("opacity", 0.9);

						div.html(country_selected)
							.style("left", (d3.event.pageX) + "px")
							.style("top", (d3.event.pageY) + "px");
						})
					.on("mouseout", function(d) {
						div.transition()
							.duration(500)
							.style("opacity", 0);
					});
			});
		}

		function generateVis() {
			// Filter the data to only include the current year
			var filtered_dataset = dataset.filter(yearFilter);

			// Stop showing the trail
			d3.selectAll("#trail").remove();

			/******** PERFORM DATA JOIN ************/
			// Join new data with old elements, if any.
			var countries = svg.selectAll("circle")
								.data(filtered_dataset);

			/******** HANDLE UPDATE SELECTION ************/
			// Update the display of existing elelemnts to match new data
			// Perform a data join and add countries to the chart
			countries
				.transition()
				.duration(500)
				.ease(d3.easeSin)
				.attr("cx", function(d) {
					// Handle the missing gci values by setting it to the last non-zero value
					if (d.Global_Competitiveness_Index == 0) {
						return d3.select(this).attr("cx");
					} else {
						return xScale(d.GDP);
					}
				})
				.attr("cy", function(d) {
					// Handle the missing gci values by setting it to the last non-zero value
					if (d.Global_Competitiveness_Index == 0) {
						return d3.select(this).attr("cy");
					} else {
						return yScale(d.Global_Competitiveness_Index);
					}
				})
				.attr("r", function(d) {
					return Math.sqrt(d.Population / Math.PI) / 400;
				})
				.attr("opacity", function(d) {
					if(d.Country == country_selected || country_selected == null) {
						return 1;
					} else {
						return 0.1;
					}
				})
				.style("fill", function(d) {
					return colorScale(color(d));
				});

			/******** HANDLE ENTER SELECTION ************/
			// Create new elements in the dataset
			// Perform a data join and add countries to the chart
			countries
				.enter()
				.append("circle")
				.attr("class", "circle")
				.attr("cx", function(d) {
					return xScale(d.GDP);
				})
				.attr("cy", function(d) {
					return yScale(d.Global_Competitiveness_Index);
				})
				.attr("r", function(d) {
					return Math.sqrt(d.Population / Math.PI) / 400;
				})
				.style("fill", function(d) {
					return colorScale(color(d));
				})
				.style("display", function(d) {
					// Check if gci value is present, then only display the element
					return d.Global_Competitiveness_Index == 0 ? "none" : null;
				})
				.on("mouseover", function(d) {
					div.transition()
						.duration(500)
						.style("opacity", 0.9);

					div.html(d.Country)
						.style("left", (d3.event.pageX) + "px")
						.style("top", (d3.event.pageY) + "px");
				})
				.on("mouseout", function(d) {
					div.transition()
						.duration(500)
						.style("opacity", 0);
				})
				.on("click", function(d){
					country_selected = d.Country;

					d3.selectAll(".circle")
						.filter(function() {
							return country_selected != d.Country;
						})
						.style("opacity", 0.1);
				});

			/******** HANDLE EXIT SELECTION ************/
			// Remove countries that no longer have a matching data eleement
			countries.exit().remove();

			// Set the year label
			d3.select("#year-header").text("Year: " + display_year);

			// Call function to draw trail paths
			drawTrail();
		}

		// Load the file data.csv and generate a visualisation based on it
		d3.csv("http://localhost:8000/data/GCI_CompleteData4.csv")
			.then( function(data) {
				console.log("Data Loaded");

				// Handle numeric type data
				data.forEach(function(d) {
					d['Year'] = +d['Year'];
					d['Population'] = +d['Population'];
					d['Global_Competitiveness_Index'] = +d['Global_Competitiveness_Index'];
					d['GDP'] = +d['GDP'];
				});

				// Assign  the data object loaded to the global dataset variable
				dataset = data;

				// Set the domains of the x and y scales using the data
				var max_gci = d3.max(dataset, function(d) { return d.Global_Competitiveness_Index; });
				var max_gdp = d3.max(dataset, function(d) { return d.GDP; });
				var min_gdp = d3.min(dataset, function(d) { return d.GDP; });

				xScale.domain([500, max_gdp]);
				yScale.domain([2, max_gci]);

				// Create the x-axis
				svg.append("g")
					.attr("class", "axis")
					.attr("transform", "translate(0," + svg_height + ")")
					.call(xAxis);

				// Create the x-axis label
				svg.append("text")
					.attr("class", "label")
					.attr("x", svg_width)
					.attr("y", svg_height - 6)
					.style("text-anchor", "end")
					.text("GDP");

				// Create the y-axis
				svg.append("g")
					.attr("class", "axis")
					.call(yAxis);

				// Create the y-axis label
				svg.append("text")
					.attr("class", "label")
					.attr("y", 6)
					.attr("dy", ".75em")
					.attr("transform", "rotate(-90)")
					.style("text-anchor", "end")
					.text("Global Competitive Index");

				// Generate the visualisations
				generateVis();
				generateMultiVis();
			});

		d3.selectAll(".button")
			.on("click", function(d) {
				// Deselect all the year buttons
				d3.select(".selected")
					.classed("selected", false);

				// Select the clicked button
				d3.select(this)
					.classed("selected", true);

				// Update the display year
				display_year = d3.select(this).text();

				// Update the visualisations
				generateVis();
				generateMultiVis();

				// Stop the animation if user selects a specific year
				clearInterval(playInterval);
			});

		d3.select(".play-button")
			.on("click", function() {
				// Deselect all the year buttons
				d3.select(".selected")
					.classed("selected", false);

				// Select the clicked button
				d3.select(this)
					.classed("selected", true);

				// Interval callback
				playInterval = setInterval(function() {
					display_year++;

					if(display_year > 2017) {
						display_year = 2007;
					}

					// Update the visualisations
					generateVis();
					generateMultiVis();
				}, 700);
			});

		d3.select(".reset-button")
			.on("click", function() {
				// Deselect all the year buttons
				d3.select(".selected")
					.classed("selected", false);

				// Select the clicked button
				d3.select(this)
					.classed("selected", true);

				// Reset the display year to 2007
				display_year = 2007;

				// Stop animation
				clearInterval(playInterval);

				// Again call vis functions to generate the visualisationa from start
				generateVis();
				generateMultiVis();

				// Deselect the selected country
				country_selected = null;
			});
		</script>
	</div>
	<hr style="clear:both;">


	<div id="countryDropdown">
		<h1>12 Pillars for Global Competitiveness Index</h1>
		<hr style="clear:both;">

		<h3 id="year-header2">Year: 2007</h3>

		Choose Country:
		<script type="text/javascript">

			svg_width = svg_width / 2;

			//Create SVG element as a group with the margins transform applied to it
			var svg2 = d3.select("body")
						.append("svg")
						.attr("width", svg_width + margin.left + margin.right)
						.attr("height", svg_height + margin.top + margin.bottom)
						.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			var pillar_names = ["1st_pillar_Institutions", "2nd_pillar_Infrastructure", "3rd_pillar_Macroeconomic_environment",
								"4th_pillar_Health_and_primary_education", "5th_pillar_Higher_education_and_training",
								"6th_pillar_Goods_market_efficiency", "7th_pillar_Labor_market_efficiency",
								"8th_pillar_Financial_market_development", "9th_pillar_Technological_readiness",
								"10th_pillar_Market_size", "11th_pillar_Business_sophistication_", "12th_pillar_Innovation"];

			var pillar_names_domain = ["Inst", "Infra", "Env", "H,PE", "HE,T",
										"Goods", "Lab", "Fin", "Tech", "Market", "Bus", "Inn"];

			var xScale2 = d3.scaleBand()
							.domain(pillar_names_domain)
							.range([0, svg_width])
							.paddingInner(0.05)
							.paddingOuter(0.05);;

			var yScale2 = d3.scaleLinear()
							.range([svg_height, 0]);

			var xAxis2 = d3.axisBottom()
							.scale(xScale2);

			var yAxis2 = d3.axisLeft()
							.scale(yScale2);

			// Maintain a map of the filtered data and their respective 12 pillars values
			var pillars_map = {};

			// Keep a track of currently selected country in the dropdown
			var selected_country = "Albania";

			svg2.append("g")
				.attr("class", "axis")
				.attr("transform", "translate(0," + svg_height + ")")
				.call(xAxis2);

			var yAxisUpdateHandler = svg2.append("g")
											.attr("class", "axis")
											.call(yAxis2);

			yAxisUpdateHandler.append("text")
								.attr("transform", "rotate(-90)")
								.attr("y", 6)
								.attr("dy", ".75em")
								.style("text-anchor", "end")
								.text("Value");

			// Define a function that filters data for the selected country
			function countryFilter(value) {
				return (value.Country == selected_country);
			}

			// Handler for change in dropdown value
			var dropdownChangeHandler = function() {
                    selected_country = d3.select(this).property('value');

					var new_data = pillars_map[selected_country];
                    addBars(new_data);
                };

			var country_dropdown = d3.select("#countryDropdown")
										.insert("select", "svg")
										.on("change", dropdownChangeHandler);

			var addBars = function (data) {
				yScale2.domain([0,7]);
                yAxisUpdateHandler.call(yAxis2);

				var bars = svg2.selectAll(".bar").data(data);

				// Add bars for new data
				bars.enter()
					.append("rect")
					.attr("class", "bar")
					.attr("x", function(d,i) {
						return xScale2(pillar_names_domain[i]);
					})
					.attr("width", xScale2.bandwidth())
					.attr("y", function(d) {
						return yScale2(d);
					})
					.attr("height", function(d) {
						return svg_height - yScale2(d);
					})
					.style("fill", "green")
					.on("mouseover", function(d) {
						div.transition()
							.duration(500)
							.style("opacity", 0.9);

						div.html(d)
							.style("left", (d3.event.pageX) + "px")
							.style("top", (d3.event.pageY) + "px");
					})
					.on("mouseout", function(d) {
						div.transition()
							.duration(500)
							.style("opacity", 0);
					});

				// Update old ones
				bars.transition()
					.duration(500)
					.attr("y", function(d) {
						return yScale2(d);
					})
					.attr("height", function(d) {
						return svg_height - yScale2(d);
					})
					.style("fill", "green");

				// Remove old ones
				bars.exit().remove();

				// Set the year label
				d3.select("#year-header2").text("Year: " + display_year);
			};

			// Generate visualisations for bars showing the 12 pillars
			function generateMultiVis() {
				// Filter the data to only include the current year
				var filtered_dataset = dataset.filter(yearFilter);

				filtered_dataset.forEach(function(d) {
                    var country = d.Country;
                    pillars_map[country] = [];

                    pillar_names.forEach(function(pillar) {
                        pillars_map[country].push( +d[pillar] );
                    });
                });

				country_dropdown.selectAll("option")
								.data(filtered_dataset)
								.enter().append("option")
								.attr("value", function(d) {
									return d.Country;
								})
								.text(function(d) {
									return d.Country;
								});

				addBars(pillars_map[selected_country]);
			}
		</script>
	</div>
</body>
</html>
