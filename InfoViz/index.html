<!DOCTYPE html>
<html>
<head>
	<title>InfoViz: Channeling Hans</title>
	<script type="text/javascript" src="./d3/d3.min.js"></script>
	<style type="text/css">
		.axis path,
		.axis line {
		    fill: none;
		    stroke: black;
		    shape-rendering: crispEdges;
		}
		.axis text {
		    font-family: sans-serif;
		    font-size: 11px;
		}
		.label {
		    font-size: 11px;
		}

		#year-header {
			text-align: center
		}
		.button-bar {
			width: 600px;
		}
		.button {
			float: left;
			margin-left: 15px;
			cursor: pointer;
		}
		.play-button,
		.reset-button {
			float: left;
			margin-left: 15px;
			cursor: pointer;
		}
		.selected {
			font-weight: bold;
		}

		.circle {
  			stroke: #000;
		}
		div.tooltip {
			position: absolute;
			text-align: center;
			font-size: 12px;
		}
	</style>
</head>

<body>
	<h1>InfoViz: Assignment 2: Part 1</h1>
	<hr style="clear:both;">
	<div class="button-bar">
		<div class="play-button">Play All</div>
		<div class="reset-button">Reset</div>
	</div>
	<hr style="clear:both;">

	<div class="button-bar">
		<div class="button selected">2007</div>
		<div class="button">2008</div>
		<div class="button">2009</div>
		<div class="button">2010</div>
		<div class="button">2011</div>
		<div class="button">2012</div>
		<div class="button">2013</div>
		<div class="button">2014</div>
		<div class="button">2015</div>
		<div class="button">2016</div>
		<div class="button">2017</div>
	</div>
	<hr style="clear:both;">

	<div class="demo">
		<h3 id="year-header">Year: 2007</h3>

		<script type="text/javascript">
		// Define margins
		var margin = { top: 30, right: 30, bottom: 30, left: 300 };

		// Width and height
		var outer_width = 1300;
		var outer_height = 650;
		var svg_width = outer_width - margin.left - margin.right;
		var svg_height = outer_height - margin.top - margin.bottom;

		// The global data set object
		var dataset;

		// The year to display
		var display_year = 2007;

		// The selected country for showing trails
		var country_selected;

		// Define a function that filters data by year
		function yearFilter(value) {
			return (value.Year == display_year);
		}

		// Define a function that filters colors by region
		function color(d) {
			return d.Region;
		}

		// Define the d3 color scale
		var colorScale = d3.scaleOrdinal(d3.schemeCategory10);

		// Set up the scale to be used on the x-axis
		var xScale = d3.scaleLog()
						.range([0, svg_width]);

		// Set up the scale to be used on the y-axis
		var yScale = d3.scaleLinear()
						.range([svg_height, 0]);

		// Create an x-axis connected to the x scale
		var xAxis = d3.axisBottom()
						.scale(xScale)
						.ticks(10, d3.format("d"));

		// Define y-axis
		var yAxis = d3.axisLeft()
				  		.scale(yScale)
						.ticks(6);

		// Define the div for the country tooltip
		var div = d3.select("body")
					.append("div")
					.attr("class", "tooltip")
					.style("opacity", 0);

		//Create SVG element as a group with the margins transform applied to it
		var svg = d3.select("body")
					.append("svg")
					.attr("width", svg_width + margin.left + margin.right)
					.attr("height", svg_height + margin.top + margin.bottom)
					.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		// Function to draw trail for the selected country
		function drawTrail () {
			var selected_country_data = dataset.filter(function(d) {
				if (country_selected != null) {
					return display_year >= d.Year && country_selected == d.Country;
				} else {
					return false;
				}
			});

			selected_country_data.forEach(function(d) {
				svg.append("circle")
					.attr("class", "circle")
					.attr("id", "trail")
					.attr("cx", xScale(d.GDP))
					.attr("cy", yScale(d.Global_Competitiveness_Index))
					.attr("r", Math.sqrt(d.Population / Math.PI) / 400)
					.attr("opacity", 1)
					.style("fill", colorScale(color(d)));
			});
		}

		function generateVis() {
			// Filter the data to only include the current year
			var filtered_dataset = dataset.filter(yearFilter);

			// Stop showing the trail
			d3.selectAll("#trail").remove();

			/******** PERFORM DATA JOIN ************/
			// Join new data with old elements, if any.
			var countries = svg.selectAll("circle")
								.data(filtered_dataset);

			/******** HANDLE UPDATE SELECTION ************/
			// Update the display of existing elelemnts to match new data
			// Perform a data join and add countries to the chart
			countries
				.transition()
				.duration(500)
				.ease(d3.easeSin)
				.attr("cx", function(d) {
					return xScale(d.GDP);
				})
				.attr("cy", function(d) {
					// Handle the missing gci values by setting it to the last known value
					if (d.Global_Competitiveness_Index == 0) {
						return d3.select(this).attr("cy");
					} else {
						return yScale(d.Global_Competitiveness_Index);
					}
				})
				.attr("r", function(d) {
					return Math.sqrt(d.Population / Math.PI) / 400;
				})
				.attr("opacity", function(d) {
					if(d.Country == country_selected || country_selected == null) {
						return 1;
					} else {
						return 0.1;
					}
				})
				.style("fill", function(d) {
					return colorScale(color(d));
				});

			/******** HANDLE ENTER SELECTION ************/
			// Create new elements in the dataset
			// Perform a data join and add countries to the chart
			countries
				.enter()
				.append("circle")
				.attr("class", "circle")
				.attr("cx", function(d) {
					return xScale(d.GDP);
				})
				.attr("cy", function(d) {
					return yScale(d.Global_Competitiveness_Index);
				})
				.attr("r", function(d) {
					return Math.sqrt(d.Population / Math.PI) / 400;
				})
				.style("fill", function(d) {
					return colorScale(color(d));
				})
				.style("display", function(d) {
					// Check if gci value is present, then only display the element
					return d.Global_Competitiveness_Index == 0 ? "none" : null;
				})
				.on("mouseover", function(d) {
					div.transition()
						.duration(500)
						.style("opacity", 0.9);

					div.html(d.Country)
						.style("left", (d3.event.pageX) + "px")
						.style("top", (d3.event.pageY - 20) + "px");
				})
				.on("mouseout", function(d) {
					div.transition()
						.duration(500)
						.style("opacity", 0);
				})
				.on("click", function(d){
					country_selected = d.Country;

					d3.selectAll(".circle")
						.filter(function() {
							return country_selected != d.Country;
						})
						.transition()
						.style("opacity", 0.1);
				});

			/******** HANDLE EXIT SELECTION ************/
			// Remove countries that no longer have a matching data eleement
			countries.exit().remove();

			// Set the year label
			d3.select("#year-header").text("Year: " + display_year);

			// Call function to draw trail paths
			drawTrail();
		}


		// Load the file data.csv and generate a visualisation based on it
		d3.csv("http://localhost:8000/data/GCI_CompleteData4.csv")
			.then( function(data) {
				console.log("Data Loaded");

				// Handle numeric type data
				data.forEach(function(d) {
					d['Year'] = +d['Year'];
					d['Population'] = +d['Population'];
					d['Global_Competitiveness_Index'] = +d['Global_Competitiveness_Index'];
					d['GDP'] = +d['GDP'];
				});

				// Assign  the data object loaded to the global dataset variable
				dataset = data;

				// Set the domains of the x and y scales using the data
				var max_gci = d3.max(dataset, function(d) { return d.Global_Competitiveness_Index; });
				var max_gdp = d3.max(dataset, function(d) { return d.GDP; });
				var min_gdp = d3.min(dataset, function(d) { return d.GDP; });

				xScale.domain([500, max_gdp]);
				yScale.domain([2, max_gci]);

				// Create the x-axis
				svg.append("g")
					.attr("class", "axis")
					.attr("transform", "translate(0," + svg_height + ")")
					.call(xAxis);

				// Create the x-axis label
				svg.append("text")
					.attr("class", "label")
					.attr("x", svg_width)
					.attr("y", svg_height - 6)
					.style("text-anchor", "end")
					.text("GDP");

				// Create the y-axis
				svg.append("g")
					.attr("class", "axis")
					.call(yAxis);

				// Create the y-axis label
				svg.append("text")
					.attr("class", "label")
					.attr("y", 6)
					.attr("dy", ".75em")
					.attr("transform", "rotate(-90)")
					.style("text-anchor", "end")
					.text("Global Competitive Index");

				// Generate the visualisation
				generateVis();
			});

		// A global variable to toggle the play interval
		var playInterval;

		d3.selectAll(".button")
			.on("click", function(d) {
				// Deselect all the year buttons
				d3.select(".selected")
					.classed("selected", false);

				// Select the clicked button
				d3.select(this)
					.classed("selected", true);

				// Update the display year
				display_year = d3.select(this).text();

				// Update the visualisation
				generateVis();

				// Stop the animation if user selects a specific year
				clearInterval(playInterval);
			});

		d3.select(".play-button")
			.on("click", function() {
				// Deselect all the year buttons
				d3.select(".selected")
					.classed("selected", false);

				// Select the clicked button
				d3.select(this)
					.classed("selected", true);

				// Interval callback
				playInterval = setInterval(function() {
					display_year++;

					if(display_year > 2017) {
						display_year = 2007;
					}

					// Update the visualisation
					generateVis();
				}, 700);
			});

		d3.select(".reset-button")
			.on("click", function() {
				// Deselect all the year buttons
				d3.select(".selected")
					.classed("selected", false);

				// Select the clicked button
				d3.select(this)
					.classed("selected", true);

				// Reset the display year to 2007
				display_year = 2007;

				// Stop animation
				clearInterval(playInterval);

				// Again call generateVis to generate the visualisation from start
				generateVis();

				// Deselect the selected country
				country_selected = null;
			});
		</script>
	</div>
</body>
</html>
